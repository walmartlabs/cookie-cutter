name: Cookie Cutter Build Workflow

on:
  push:
    branches: [ master, develop, ^release/.*$]
  pull_request:
    branches: [ master, develop, ^release/.*$ ]
  schedule:
    - cron:  '0 4 * * *'

jobs:
  smoke:
    name: Ubuntu Node 10 Smoke
    runs-on: ubuntu-latest
    outputs:
      commit_message: ${{ steps.output_message.outputs.commit_message }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with: # required for git log to access the correct commits
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Get Commit Message
        run: echo "COMMIT_MESSAGE=$(git log --format=%B -n 1 ${{ github.event.after }})" >> $GITHUB_ENV
      - name: Set Output Commit Message
        id: output_message
        env:
          COMMIT_MESSAGE: ${{ env.COMMIT_MESSAGE }}
        run: |
              echo "::set-output name=commit_message::$COMMIT_MESSAGE"
              echo Commit Message: "$COMMIT_MESSAGE"

  integration-azure:
    name: Azure Integration
    if: ${{ github.event_name == 'schedule' || ( github.event_name == 'pull_request' && ( github.base_ref == 'master' || contains(needs.smoke.outputs.commit_message, '[full ci]') || contains(needs.smoke.outputs.commit_message, '[full-ci]') ) ) }}
    needs: smoke
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Setup Windows Node 10
        uses: actions/setup-node@v2-beta
        with:
          node-version: "10"
      - name: Install Yarn 1.21.1
        run: yarn set version 1.21.1
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      - name: Run Integrate
        env:
          YARN_GPG: no # Windows build agent will hang without this
          NODE_TLS_REJECT_UNAUTHORIZED: "0"
          COSMOS_SECRET_KEY: "C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="
          AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;"
          AZURE_STORAGE_ACCESS_KEY: "Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw=="
          AZURE_STORAGE_ACCOUNT: "devstoreaccount1"
          AZURE_STORAGE_URL: "http://127.0.0.1:10000/devstoreaccount1"
          RUNNING_IN_CI: "1"
        run: |
              PowerShell -c "Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope LocalMachine"
              PowerShell -File packages/azure/start_emulators.ps1
              PowerShell -File packages/azure/run_integration_tests.ps1
