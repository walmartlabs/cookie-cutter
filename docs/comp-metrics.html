<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Metrics · Cookie Cutter</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Services will want to record metrics to track error rates for message processing, counts for incoming and outgoing messages, or anything internal to the state of service itself. Cookie Cutter provides a general purpose metrics recorder that can be connected to various backends. The framework already emits many useful metrics out of the box; Custom metrics can be emitted by message handlers, custom input sources, output sinks or state providers."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Metrics · Cookie Cutter"/><meta property="og:type" content="website"/><meta property="og:url" content="https://walmartlabs.github.io/cookie-cutter/"/><meta property="og:description" content="Services will want to record metrics to track error rates for message processing, counts for incoming and outgoing messages, or anything internal to the state of service itself. Cookie Cutter provides a general purpose metrics recorder that can be connected to various backends. The framework already emits many useful metrics out of the box; Custom metrics can be emitted by message handlers, custom input sources, output sinks or state providers."/><meta property="og:image" content="https://walmartlabs.github.io/cookie-cutter/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://walmartlabs.github.io/cookie-cutter/img/docusaurus.png"/><link rel="shortcut icon" href="/cookie-cutter/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/cookie-cutter/js/scrollSpy.js"></script><link rel="stylesheet" href="/cookie-cutter/css/main.css"/><script src="/cookie-cutter/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cookie-cutter/"><img class="logo" src="/cookie-cutter/img/cookie.svg" alt="Cookie Cutter"/><h2 class="headerTitleWithLogo">Cookie Cutter</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/cookie-cutter/docs/intro-getting-started" target="_self">Introduction</a></li><li class="siteNavGroupActive"><a href="/cookie-cutter/docs/intro-inputs" target="_self">API</a></li><li class=""><a href="/cookie-cutter/help" target="_self">Help</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Components</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-getting-started">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-inputs">Inputs</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-message-handling">Message Handling</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-outputs">Outputs</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/versioning-contribution">Versioning and Contribution Guide</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Components</h3><ul class=""><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-dispatch-context">Dispatch Context</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-state">State</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/cookie-cutter/docs/comp-metrics">Metrics</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-tracing">Tracing</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-logging">Logging</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-validation">Validation</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-encoding">Encoding</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-config">Config</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-testing">Testing</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Modules</h3><ul class=""><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-kafka">Kafka</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-azure">Azure</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-amqp">AMQP</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-grpc">gRPC</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-validatejs">ValidateJS</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-mssql">MSSQL</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-timer">Timer</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-statsd">StatsD</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-protobuf">Protobuf</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-prometheus">Prometheus</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-redis">Redis</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-s3">S3</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-google-pubsub">Google PubSub</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Metrics</h1></header><article><div><span><p>Services will want to record metrics to track error rates for message processing, counts for incoming and outgoing messages, or anything internal to the state of service itself. Cookie Cutter provides a general purpose metrics recorder that can be connected to various backends. The framework already emits many useful metrics out of the box; Custom metrics can be emitted by message handlers, custom input sources, output sinks or state providers.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> IMetricTags {
    readonly [key: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> IMetrics {
    increment(key: <span class="hljs-built_in">string</span>, tags?: IMetricTags): <span class="hljs-built_in">void</span>;
    increment(key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">number</span>, tags?: IMetricTags): <span class="hljs-built_in">void</span>;
    gauge(key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">number</span>, tags?: IMetricTags): <span class="hljs-built_in">void</span>;
    timing(key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">number</span>, tags?: IMetricTags): <span class="hljs-built_in">void</span>;
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="metrics-from-a-message-handler"></a><a href="#metrics-from-a-message-handler" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metrics from a Message Handler</h2>
<p>Below is an example of a custom metric that records how much money is spent in an online shop and allows the data to be graphed on a time interval. The <code>region</code> tag can be used to further slice the data when visualizing it (e.g. one line per region on a time chart).</p>
<pre><code class="hljs css language-typescript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onOrderPlaced</span>(<span class="hljs-params">msg: IOrderPlaced, ctx: IDispatchContext</span>): <span class="hljs-title">void</span> </span>{
    ctx.metrics.increment(<span class="hljs-string">"$ spent"</span>, msg.amount, {
        region: msg.customer.address.state,
    });
}
</code></pre>
<p>Metrics recorded inside of a message handler do not immediately get published by the underlying metrics recorder. Similarly to the <a href="/cookie-cutter/docs/comp-dispatch-context#publish-store">DispatchContext</a> within a message handler, metrics will be buffered and only after the message handler function successfully returns will it pass the set of recorded metrics to the metrics recorder for publishing. Any message handlers that throw an error will clear any metrics that have been buffered.</p>
<h2><a class="anchor" aria-hidden="true" id="metric-annotators"></a><a href="#metric-annotators" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Metric Annotators</h2>
<p>Metric Annotators allow services to add additional tags to the metrics emitted by the core framework. An example where this can be useful are multi tenant systems where every message processed contains the tenant id and we would like to be able to monitor our SLAs per tenant.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> IMessageMetricAnnotator {
    annotate(msg: IMessage): IMetricTags;
}

<span class="hljs-keyword">class</span> MyMetricAnnotator <span class="hljs-keyword">implements</span> IMessageMetricAnnotator {
    <span class="hljs-keyword">public</span> annotate(msg: IMessage): IMetricTags {
        <span class="hljs-keyword">return</span> {
            tenantId: msg.payload.tenantId,
        };
    }
}

Application.create()
    .input()
        .add(<span class="hljs-comment">/* some input source */</span>)
        .annotate(<span class="hljs-keyword">new</span> MyMetricAnnotator())
        .done()
    <span class="hljs-comment">// ...</span>
    .run();
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="core-metrics"></a><a href="#core-metrics" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Core Metrics</h2>
<p>Services that setup a metrics recorder will by default collect a few different metrics listed below as part of the normal input-dispatch-output message flow. Depending on the message processing mode additional metrics may be collected.</p>
<table>
<thead>
<tr><th>Name</th><th>Description</th><th>Message Processing Mode</th><th>Type</th><th>Tags</th></tr>
</thead>
<tbody>
<tr><td>cookie_cutter.core.received</td><td>A message that has come off the wire that a dispatch handler exists for</td><td>All</td><td><code>increment</code></td><td><code>event_type</code></td></tr>
<tr><td>cookie_cutter.core.processed</td><td>A message that has been processed</td><td>All</td><td><code>increment</code></td><td><code>event_type</code>, <code>result</code></td></tr>
<tr><td>cookie_cutter.core.store</td><td>A stored message was processed by an output sink</td><td>All</td><td><code>increment</code></td><td><code>event_type</code>, <code>result</code></td></tr>
<tr><td>cookie_cutter.core.publish</td><td>A published message was processed by an output sink</td><td>All</td><td><code>increment</code></td><td><code>event_type</code>, <code>result</code></td></tr>
<tr><td>cookie_cutter.core.input_queue</td><td>The number of messages that have come off the wire waiting to be handled</td><td>Concurrent &amp; Rpc</td><td><code>gauge</code></td><td>None</td></tr>
<tr><td>cookie_cutter.core.output_queue</td><td>The number of buffered dispatch contexts waiting to be processed by the output loop</td><td>Concurrent &amp; Rpc</td><td><code>gauge</code></td><td>None</td></tr>
<tr><td>cookie_cutter.core.output_batch</td><td>The number of buffered dispatch contexts that have been batched within the output loop waiting to be processed by an output sink</td><td>Concurrent &amp; Rpc</td><td><code>gauge</code></td><td>None</td></tr>
<tr><td>cookie_cutter.core.concurrent_handlers</td><td>The number of handlers currently executing concurrently</td><td>Rpc</td><td><code>gauge</code></td><td>None</td></tr>
</tbody>
</table>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/cookie-cutter/docs/comp-state"><span class="arrow-prev">← </span><span>State</span></a><a class="docs-next button" href="/cookie-cutter/docs/comp-tracing"><span>Tracing</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#metrics-from-a-message-handler">Metrics from a Message Handler</a></li><li><a href="#metric-annotators">Metric Annotators</a></li><li><a href="#core-metrics">Core Metrics</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/cookie-cutter/" class="nav-home"><img src="/cookie-cutter/img/cookie.svg" alt="Cookie Cutter" width="66" height="58"/></a><div><h5>Docs</h5><a href="/cookie-cutter/docs/intro-getting-started.html">Introduction</a><a href="/cookie-cutter/docs/module-kafka.html">Kafka</a></div><div><h5>More</h5><a href="/cookie-cutter/blog">Blog</a></div></section><section class="copyright">Copyright © 2022 Walmart Inc.</section></footer></div></body></html>