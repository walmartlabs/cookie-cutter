<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Testing · Cookie Cutter</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Introduction"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Testing · Cookie Cutter"/><meta property="og:type" content="website"/><meta property="og:url" content="https://walmartlabs.github.io/cookie-cutter/"/><meta property="og:description" content="## Introduction"/><meta property="og:image" content="https://walmartlabs.github.io/cookie-cutter/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://walmartlabs.github.io/cookie-cutter/img/docusaurus.png"/><link rel="shortcut icon" href="/cookie-cutter/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/cookie-cutter/js/scrollSpy.js"></script><link rel="stylesheet" href="/cookie-cutter/css/main.css"/><script src="/cookie-cutter/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/cookie-cutter/"><img class="logo" src="/cookie-cutter/img/cookie.svg" alt="Cookie Cutter"/><h2 class="headerTitleWithLogo">Cookie Cutter</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/cookie-cutter/docs/intro-getting-started" target="_self">Introduction</a></li><li class="siteNavGroupActive"><a href="/cookie-cutter/docs/intro-inputs" target="_self">API</a></li><li class=""><a href="/cookie-cutter/help" target="_self">Help</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Components</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Introduction</h3><ul class=""><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-getting-started">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-inputs">Inputs</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-message-handling">Message Handling</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/intro-outputs">Outputs</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/versioning-contribution">Versioning and Contribution Guide</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Components</h3><ul class=""><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-dispatch-context">Dispatch Context</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-state">State</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-metrics">Metrics</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-tracing">Tracing</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-logging">Logging</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-validation">Validation</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-encoding">Encoding</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/comp-config">Config</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/cookie-cutter/docs/comp-testing">Testing</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Modules</h3><ul class=""><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-kafka">Kafka</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-azure">Azure</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-amqp">AMQP</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-grpc">gRPC</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-validatejs">ValidateJS</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-mssql">MSSQL</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-timer">Timer</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-statsd">StatsD</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-protobuf">Protobuf</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-prometheus">Prometheus</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-redis">Redis</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-s3">S3</a></li><li class="navListItem"><a class="navItem" href="/cookie-cutter/docs/module-google-pubsub">Google PubSub</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Testing</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="introduction"></a><a href="#introduction" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Introduction</h2>
<p>Cookie Cutter ships with a mechanism to easily write end-to-end integration tests. Test cases are stated in the form of inputs that are expected to produce certain outputs. This is a rather high-level approach to testing that views the service itself as a black box and only verifies that it adheres to its contracts from an outside observer's perspective. The advantage of this approach is that test suites remain valid and do not need any changes even if the internals of a service are redesigned or rewritten. However, more granular unit tests can be used in conjunction with this approach.</p>
<p>The example below shows a simple service that emits one output message for every input and the corresponding integration test for it.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-comment">// ---------- ACTUAL APPLICATION ----------</span>
<span class="hljs-keyword">class</span> MessageHandler {
    <span class="hljs-keyword">public</span> onMyInput(msg: IMyInput, ctx: IDispatchContext): <span class="hljs-built_in">void</span> {
        ctx.publish(Output, { value: msg.id + <span class="hljs-number">1</span> });
    }
}

Application.create()
    .input()
        .add(<span class="hljs-comment">/* some input source */</span>)
        .done()
    .dispatch(<span class="hljs-keyword">new</span> MessageHandler())
    .output()
        .published(<span class="hljs-comment">/* some output sink */</span>)
        .done()
    .run();


<span class="hljs-comment">// ---------- INTEGRATION TESTS ----------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTestApp</span>(<span class="hljs-params"></span>): <span class="hljs-title">IApplicationBuilder</span> </span>{
    <span class="hljs-keyword">return</span> Application.create()
        .dispatch(<span class="hljs-keyword">new</span> MessageHandler());
}

describe(<span class="hljs-string">"My Application"</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    it(<span class="hljs-string">"produces Outputs with correct value"</span>, <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> runIntegrationTest(createTestApp(), [
            msg(MyInput, { id: <span class="hljs-number">7</span> }),
            msg(MyInput, { id: <span class="hljs-number">12</span> }),
        ]);

        expect(result.outputs).toMatchObject([
            msg(Output, { value: <span class="hljs-number">8</span> }),
            msg(Output, { value: <span class="hljs-number">13</span> }),
        ]);
    });
});
</code></pre>
<p>An integration test is very similar to the actual application setup. The only difference is that the test application has no inputs and no outputs defined and we do not call the <code>run</code> method directly. When the test application is passed to <code>runIntegrationTest</code> it will add a mock input source and mock output sinks before running that application. The test application should be configured as similar as possible to the application defined for the actual service, meaning it should use the same message handler setup, validation, type mapper, etc ... Only things that would cause any kind of external communication (tracing, metrics, sources, sinks ...) should either be left out or need to be mocked.</p>
<h2><a class="anchor" aria-hidden="true" id="test-result"></a><a href="#test-result" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Test Result</h2>
<p><code>runIntegrationTest</code> returns the following data</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> ITestResult {
    readonly published: IPublishedMessage[];
    readonly stored: IStoredMessage[];
    readonly outputs: IMessage[];
    readonly responses: <span class="hljs-built_in">any</span>[];
}
</code></pre>
<ul>
<li><em>published</em> contains all messages that were published from message handlers with additional context</li>
<li><em>stored</em> contains all messages that were published from message handlers with additional context</li>
<li><em>outputs</em> contains the inner messages from stored and published (first all stored messages, then the published ones)</li>
<li><em>responses</em> contains the return values from each message handler, this is only useful for RPC handlers</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="mocking-state-event-sourced"></a><a href="#mocking-state-event-sourced" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mocking State (Event Sourced)</h2>
<p>Event Sourced state can be mocked with the <code>mockState</code> helper functions. It accepts one parameter that contains events per event-stream.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTestApp</span>(<span class="hljs-params"></span>): <span class="hljs-title">IApplicationBuilder</span> </span>{
    <span class="hljs-keyword">return</span> Application.create()
        .dispatch(<span class="hljs-keyword">new</span> MessageHandler())
        .state(mockState({
            [<span class="hljs-string">"customer-1"</span>]: [
                msg(CustomerRegistered, { id: <span class="hljs-number">1</span>, name: <span class="hljs-string">"John Doe"</span> }),
                msg(CustomerEmailChanged, { email: <span class="hljs-string">"john@doe.com"</span> }),
            ]
        }));
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="mocking-state-materialized"></a><a href="#mocking-state-materialized" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mocking State (Materialized)</h2>
<p>Materialized views can be mocked with <code>mockMaterializedState</code> helper function:</p>
<pre><code class="hljs css language-typescript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTestApp</span>(<span class="hljs-params"></span>): <span class="hljs-title">IApplicationBuilder</span> </span>{
    <span class="hljs-keyword">return</span> Application.create()
        .dispatch(<span class="hljs-keyword">new</span> MessageHandler())
        .state(mockMaterializedState(Customer, {
            <span class="hljs-string">"customer-1"</span>: <span class="hljs-keyword">new</span> Customer({name: <span class="hljs-string">"John Doe"</span>}),
            <span class="hljs-string">"customer-2"</span>: <span class="hljs-keyword">new</span> Customer({name: <span class="hljs-string">"Jane Doe"</span>})
        }));
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="truncating-outputs"></a><a href="#truncating-outputs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Truncating Outputs</h2>
<p>Sometimes it can be useful not to record all published or stored messages, but only some of them. An example might be multiple input messages that are required to setup the correct state on which the last input message is then supposed to act upon. This can be done with a special input message called the truncate beacon.</p>
<pre><code class="hljs css language-typescript">describe(<span class="hljs-string">"My Application"</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    it(<span class="hljs-string">"produces Outputs with correct value"</span>, <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> runIntegrationTest(createTestApp(), [
            msg(UserCreated, { name: <span class="hljs-string">"john"</span> }),
            msg(UserCreated, { name: <span class="hljs-string">"jane"</span> }),
            truncateOutputBeacon(), <span class="hljs-comment">// forget all the outputs up to this point</span>
            msg(FriendRequestSent, { <span class="hljs-keyword">from</span>: <span class="hljs-string">"john"</span>, to: <span class="hljs-string">"jane"</span> }),
        ]);

        expect(result.outputs).toMatchObject([
            msg(FriendRequestAccepted, { ... }),
        ]);
    });
});
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="defining-metadata"></a><a href="#defining-metadata" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Defining Metadata</h2>
<p>The <code>msg</code> helper function can be used to create instances of <code>IMessage</code> or <code>MessageRef</code> that are expected by <code>runIntegrationTest</code>. It will implicitly use the <code>ObjectNameMessageTypeMapper</code> to generate the message's typename. If a 3rd parameter is passed to <code>msg</code> it will return a <code>MessageRef</code> instead of an <code>IMessage</code> that contains additional metadata. Generally this is only required if you have message handlers that operate on this metadata.</p>
<pre><code class="hljs css language-typescript"><span class="hljs-keyword">class</span> MessageHandler {
    <span class="hljs-keyword">public</span> onMyInput(msg: IMyInput, ctx: IDispatchContext): <span class="hljs-built_in">void</span> {
        ctx.publish(MyInput, msg, {
            [KafkaMetadata.Key]: ctx.metadata&lt;<span class="hljs-built_in">string</span>&gt;(KafkaMetadata.Key),
        });
    }
}

describe(<span class="hljs-string">"My Application"</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    it(<span class="hljs-string">"publishes with same key it received"</span>, <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> runIntegrationTest(createTestApp(), [
            msg(MyInput, { id: <span class="hljs-number">7</span> }, { [KafkaMetadata.Key]: <span class="hljs-string">"abc"</span> }),
        ]);

        expect(result.published).toMatchObject([
            { metadata: { [KafkaMetadata.Key]: <span class="hljs-string">"abc"</span> } },
        ]);
    });
});
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/cookie-cutter/docs/comp-config"><span class="arrow-prev">← </span><span>Config</span></a><a class="docs-next button" href="/cookie-cutter/docs/module-kafka"><span>Kafka</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#introduction">Introduction</a></li><li><a href="#test-result">Test Result</a></li><li><a href="#mocking-state-event-sourced">Mocking State (Event Sourced)</a></li><li><a href="#mocking-state-materialized">Mocking State (Materialized)</a></li><li><a href="#truncating-outputs">Truncating Outputs</a></li><li><a href="#defining-metadata">Defining Metadata</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/cookie-cutter/" class="nav-home"><img src="/cookie-cutter/img/cookie.svg" alt="Cookie Cutter" width="66" height="58"/></a><div><h5>Docs</h5><a href="/cookie-cutter/docs/intro-getting-started.html">Introduction</a><a href="/cookie-cutter/docs/module-kafka.html">Kafka</a></div><div><h5>More</h5><a href="/cookie-cutter/blog">Blog</a></div></section><section class="copyright">Copyright © 2022 Walmart Inc.</section></footer></div></body></html>